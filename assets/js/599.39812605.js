(window.webpackJsonp=window.webpackJsonp||[]).push([[599],{1072:function(t,s,a){"use strict";a.r(s);var n=a(14),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"_9-8-自定义包的目录结构、go-install-和-go-test"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_9-8-自定义包的目录结构、go-install-和-go-test"}},[t._v("#")]),t._v(" 9.8 自定义包的目录结构、go install 和 go test")]),t._v(" "),s("p",[t._v("为了示范，我们创建了一个名为 "),s("code",[t._v("uc")]),t._v(" 的简单包，它含有一个 "),s("code",[t._v("UpperCase")]),t._v(" 函数将字符串的所有字母转换为大写。当然这并不值得创建一个自定义包，同样的功能已被包含在 "),s("code",[t._v("strings")]),t._v(" 包里，但是同样的技巧也可以应用在更复杂的包中。")]),t._v(" "),s("h2",{attrs:{id:"_9-8-1-自定义包的目录结构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_9-8-1-自定义包的目录结构"}},[t._v("#")]),t._v(" 9.8.1 自定义包的目录结构")]),t._v(" "),s("p",[t._v("下面的结构给了你一个好的示范（"),s("code",[t._v("uc")]),t._v(" 代表通用包名, 名字为粗体的代表目录，斜体代表可执行文件）:")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[t._v("/home/user/goprograms\n\tucmain.go\t(uc 包主程序)\n\tMakefile (ucmain 的 makefile)\n\tucmain\n\tsrc/uc\t (包含 uc 包的 go 源码)\n\t\tuc.go\n\t \tuc_test.go\n\t \tMakefile (包的 makefile)\n\t \tuc.a\n\t \t_obj\n\t\t\tuc.a\n\t\t_test\n\t\t\tuc.a\n\tbin\t\t(包含最终的执行文件)\n\t\tucmain\n\tpkg/linux_amd64\n\t\tuc.a\t(包的目标文件)\n")])])]),s("p",[t._v("将你的项目放在 goprograms 目录下(你可以创建一个环境变量 "),s("code",[t._v("GOPATH")]),t._v("，详见第 "),s("RouterLink",{attrs:{to:"/the-way-to-go/02.2.html"}},[t._v("2.2")]),t._v("/"),s("RouterLink",{attrs:{to:"/the-way-to-go/02.3.html"}},[t._v("3")]),t._v(" 章节：在 "),s("code",[t._v(".profile")]),t._v(" 和 "),s("code",[t._v(".bashrc")]),t._v(" 文件中添加 "),s("code",[t._v("export GOPATH=/home/user/goprograms")]),t._v(")，而你的项目将作为 "),s("code",[t._v("src")]),t._v(" 的子目录。"),s("code",[t._v("uc")]),t._v(" 包中的功能在 uc.go 中实现。")],1),t._v(" "),s("p",[t._v("示例 9.6 "),s("a",{attrs:{href:"examples/chapter_9/uc.go"}},[t._v("uc.go")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-go extra-class"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" uc\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"strings"')]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("UpperCase")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("str "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" strings"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ToUpper")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("str"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("包通常附带一个或多个测试文件，在这我们创建了一个 uc_test.go 文件，如"),s("RouterLink",{attrs:{to:"/the-way-to-go/09.8.html"}},[t._v("第 9.8 节")]),t._v("所述。")],1),t._v(" "),s("p",[t._v("示例 9.7 "),s("a",{attrs:{href:"examples/chapter_9/test.go"}},[t._v("test.go")])]),t._v(" "),s("div",{staticClass:"language-go extra-class"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" uc\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"testing"')]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" ucTest "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" out "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" ucTests "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("ucTest "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tucTest"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"abc"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ABC"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tucTest"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cvo-az"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"CVO-AZ"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tucTest"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Antwerp"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ANTWERP"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("TestUC")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("testing"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("T"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ut "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("range")]),t._v(" ucTests "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tuc "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("UpperCase")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ut"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("in"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" uc "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" ut"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\tt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Errorf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"UpperCase(%s) = %s, must be %s"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ut"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("in"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" uc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tut"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("通过指令编译并安装包到本地："),s("code",[t._v("go install uc")]),t._v(", 这会将 uc.a 复制到 pkg/linux_amd64 下面。")]),t._v(" "),s("p",[t._v("另外，使用 make ，通过以下内容创建一个包的 Makefile 在 src/uc 目录下:")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("include $(GOROOT)/src/Make.inc\n\nTARG=uc\nGOFILES=\\\n\t\tuc.go\\\n\ninclude $(GOROOT)/src/Make.pkg\n")])])]),s("p",[t._v("在该目录下的命令行调用: gomake")]),t._v(" "),s("p",[t._v("这将创建一个 _obj 目录并将包编译生成的存档 uc.a 放在该目录下。")]),t._v(" "),s("p",[t._v("这个包可以通过 go test 测试。")]),t._v(" "),s("p",[t._v("创建一个 uc.a 的测试文件在目录下，输出为 "),s("code",[t._v("PASS")]),t._v(" 时测试通过。")]),t._v(" "),s("p",[t._v("在"),s("RouterLink",{attrs:{to:"/the-way-to-go/13.8.html"}},[t._v("第 13.8 节")]),t._v("我们将给出另外一个测试例子并进行深入研究。")],1),t._v(" "),s("p",[t._v("备注：有可能你当前的用户不具有足够的资格使用 go install（没有权限）。这种情况下，选择 root 用户 su。确保 Go 环境变量和 Go 源码路径也设置给 su，同样也适用你的普通用户（详见"),s("RouterLink",{attrs:{to:"/the-way-to-go/02.3.html"}},[t._v("第 2.3 节")]),t._v("）。")],1),t._v(" "),s("p",[t._v("接下来我们创建主程序 ucmain.go:")]),t._v(" "),s("p",[t._v("示例 9.8 "),s("a",{attrs:{href:"/examples/chapter_9/ucmain.go"}},[t._v("ucmain.go")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-go extra-class"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" main\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./src/uc"')]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fmt"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tstr1 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"USING package uc!"')]),t._v("\n\tfmt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("uc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("UpperCase")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("str1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("然后在这个目录下输入 "),s("code",[t._v("go install")]),t._v("。")]),t._v(" "),s("p",[t._v("另外复制 uc.a 到 /home/user/goprograms 目录并创建一个 Makefile 并写入文本：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("include $(GOROOT)/src/Make.inc\nTARG=ucmain\nGOFILES=\\\n\tucmain.go\\\n\ninclude $(GOROOT)/src/Make.cmd\n")])])]),s("p",[t._v("执行 gomake 编译 "),s("code",[t._v("ucmain.go")]),t._v(" 生成可执行文件 ucmain")]),t._v(" "),s("p",[t._v("运行 "),s("code",[t._v("./ucmain")]),t._v(" 显示: "),s("code",[t._v("USING PACKAGE UC!")]),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"_9-8-2-本地安装包"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_9-8-2-本地安装包"}},[t._v("#")]),t._v(" 9.8.2 本地安装包")]),t._v(" "),s("p",[t._v("本地包在用户目录下，使用给出的目录结构，以下命令用来从源码安装本地包：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[t._v("go install /home/user/goprograms/src/uc # 编译安装 uc\ncd /home/user/goprograms/uc\ngo install ./uc \t# 编译安装 uc（和之前的指令一样）\ncd ..\ngo install .\t# 编译安装 ucmain\n")])])]),s("p",[t._v("安装到 "),s("code",[t._v("$GOPATH")]),t._v(" 下：")]),t._v(" "),s("p",[t._v("如果我们想安装的包在系统上的其他 Go 程序中被使用，它一定要安装到 "),s("code",[t._v("$GOPATH")]),t._v(" 下。\n这样做，在 .profile 和 .bashrc 中设置 "),s("code",[t._v("export GOPATH=/home/user/goprograms")]),t._v("。")]),t._v(" "),s("p",[t._v("然后执行 "),s("code",[t._v("go install uc")]),t._v(" 将会复制包存档到 "),s("code",[t._v("$GOPATH/pkg/LINUX_AMD64/uc")]),t._v("。")]),t._v(" "),s("p",[t._v("现在，uc 包可以通过 "),s("code",[t._v('import "uc"')]),t._v(" 在任何 Go 程序中被引用。")]),t._v(" "),s("h2",{attrs:{id:"_9-8-3-依赖系统的代码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_9-8-3-依赖系统的代码"}},[t._v("#")]),t._v(" 9.8.3 依赖系统的代码")]),t._v(" "),s("p",[t._v("在不同的操作系统上运行的程序以不同的代码实现是非常少见的：绝大多数情况下语言和标准库解决了大部分的可移植性问题。")]),t._v(" "),s("p",[t._v("你有一个很好的理由去写平台特定的代码，例如汇编语言。这种情况下，按照下面的约定是合理的：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[t._v("prog1.go\nprog1_linux.go\nprog1_darwin.go\nprog1_windows.go\n")])])]),s("p",[t._v("prog1.go 定义了不同操作系统通用的接口，并将系统特定的代码写到 prog1_os.go 中。\n对于 Go 工具你可以指定 "),s("code",[t._v("prog1_$GOOS.go")]),t._v(" 或 "),s("code",[t._v("prog1_$GOARCH.go")]),t._v("\n或在平台 Makefile 中："),s("code",[t._v("prog1_$(GOOS).go\\")]),t._v(" 或 "),s("code",[t._v("prog1_$(GOARCH).go\\")]),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"链接"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#链接"}},[t._v("#")]),t._v(" 链接")]),t._v(" "),s("ul",[s("li",[s("RouterLink",{attrs:{to:"/the-way-to-go/directory.html"}},[t._v("目录")])],1),t._v(" "),s("li",[t._v("上一节："),s("RouterLink",{attrs:{to:"/the-way-to-go/09.7.html"}},[t._v("使用 go install 安装自定义包")])],1),t._v(" "),s("li",[t._v("下一节："),s("RouterLink",{attrs:{to:"/the-way-to-go/09.9.html"}},[t._v("通过 Git 打包和安装")])],1)])])}),[],!1,null,null,null);s.default=e.exports}}]);