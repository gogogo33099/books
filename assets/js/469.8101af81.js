(window.webpackJsonp=window.webpackJsonp||[]).push([[469],{910:function(s,t,a){"use strict";a.r(t);var e=a(14),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"express-cookie-parser-签名机制深入剖析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#express-cookie-parser-签名机制深入剖析"}},[s._v("#")]),s._v(" express+cookie_parser：签名机制深入剖析")]),s._v(" "),t("h2",{attrs:{id:"写在前面"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#写在前面"}},[s._v("#")]),s._v(" 写在前面")]),s._v(" "),t("p",[s._v("本文先简单介绍session跟cookie的区别与联系，接着深入剖析"),t("code",[s._v("express-session")]),s._v("中间件的实现。关于"),t("code",[s._v("express-session")]),s._v("的基础使用，可参见笔者前面的文章。")]),s._v(" "),t("h2",{attrs:{id:"session-vs-cookie-vs-登录态"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#session-vs-cookie-vs-登录态"}},[s._v("#")]),s._v(" session vs cookie vs 登录态")]),s._v(" "),t("p",[s._v("HTTP是无状态的，也就是说，同个用户，多次访问同一个网站，网站无法区分前后访问的是否同个用户。cookie跟session的出现很好的解决了这个问题。")]),s._v(" "),t("p",[s._v("抛开两者的学术定义，从应用的角度来讲，session跟cookie就是一对好基友，可以用来实现用户的身份识别。")]),s._v(" "),t("p",[s._v("session是保存在服务端的小段数据，cookie是保存在用户本地的小段数据，它们一般是一一对应的。")]),s._v(" "),t("p",[s._v("上面的解释比较抽象，先举两个常见的例子："),t("strong",[s._v("用户登录")]),s._v(" 和 "),t("strong",[s._v("登录态检验")]),s._v("。")]),s._v(" "),t("h3",{attrs:{id:"用户登录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#用户登录"}},[s._v("#")]),s._v(" 用户登录")]),s._v(" "),t("ol",[t("li",[s._v("张三：在网站输入用户名(zhang)、密码，点击“登录”。")]),s._v(" "),t("li",[s._v("浏览器：向服务端发送登录请求。")]),s._v(" "),t("li",[s._v("服务端：收到登录请求，对 用户名、密码 进行校验，且校验通过。")]),s._v(" "),t("li",[s._v("服务端：把张三的用户名 zhang 写到本地文件 session.txt。（session）")]),s._v(" "),t("li",[s._v("服务端：请求成功返回，附带 "),t("code",[s._v("Set-Cookie:uid=zhang")]),s._v(" 首部。")]),s._v(" "),t("li",[s._v("浏览器：收到服务端返回，检测到 "),t("code",[s._v("Set-Cookie")]),s._v(" 首部，将cookie("),t("code",[s._v("uid=zhang")]),s._v(")保存到本地。(cookie)")])]),s._v(" "),t("h3",{attrs:{id:"登录态检验"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#登录态检验"}},[s._v("#")]),s._v(" 登录态检验")]),s._v(" "),t("p",[s._v("张三再次访问网站：")]),s._v(" "),t("ol",[t("li",[s._v("张三：访问网站的个人主页。")]),s._v(" "),t("li",[s._v("浏览器：向服务端发送访问请求（带上之前的cookie）。")]),s._v(" "),t("li",[s._v("服务端：解析cookie，找到"),t("code",[s._v("uid=zhang")]),s._v("。")]),s._v(" "),t("li",[s._v("服务端：查找本地session.txt，发现"),t("code",[s._v("uid=zhang")]),s._v("这条记录，判断用户已登录。")]),s._v(" "),t("li",[s._v("服务端：返回个人主页。")])]),s._v(" "),t("h2",{attrs:{id:"express-session实现原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#express-session实现原理"}},[s._v("#")]),s._v(" express-session实现原理")]),s._v(" "),t("p",[s._v("关键配置如下。其中，"),t("code",[s._v("saveUninitialized")]),s._v("若为"),t("code",[s._v("true")]),s._v("，对状态为“未初始化”的会话，服务端会自动为该会话创建session id，并保存到本地。")]),s._v(" "),t("p",[s._v("对于需要实现登录功能的站点，需要将"),t("code",[s._v("saveUninitialized")]),s._v("设置为"),t("code",[s._v("false")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-js extra-class"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("app"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("use")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("session")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" identityKey"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("secret")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'chyingp'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 用来对session id相关的cookie进行签名")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("store")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FileStore")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 本地存储session（文本文件，也可以选择其他store，比如redis的）")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("saveUninitialized")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 是否自动保存未初始化的会话，建议false")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("resave")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 是否每次都重新保存会话，建议false")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("cookie")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("maxAge")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 有效期，单位是毫秒")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[s._v("从请求的生命周期来看下express-session是怎么发挥作用的。")]),s._v(" "),t("p",[s._v("首先，是一个“未初始化”的请求（比如第一次访问网站的用户）")]),s._v(" "),t("div",{staticClass:"language-js extra-class"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("app"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("use")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("session")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* 配置项 */")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\napp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("use")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" next")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("end")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ok'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("h2",{attrs:{id:"关注点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#关注点"}},[s._v("#")]),s._v(" 关注点")]),s._v(" "),t("ol",[t("li",[s._v("防止cookie篡改")]),s._v(" "),t("li",[s._v("登录态超时机制")]),s._v(" "),t("li",[s._v("登录态主动失效机制")])])])}),[],!1,null,null,null);t.default=n.exports}}]);