(window.webpackJsonp=window.webpackJsonp||[]).push([[473],{915:function(a,t,s){"use strict";s.r(t);var n=s(14),e=Object(n.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"n-api"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#n-api"}},[a._v("#")]),a._v(" n-api")]),a._v(" "),t("h2",{attrs:{id:"n-api简介"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#n-api简介"}},[a._v("#")]),a._v(" N-API简介")]),a._v(" "),t("p",[a._v("Node.js 8.0 在2017年6月份发布，升级的特性中，包含了N-API。编写过或者使用过 node扩展的同学，不少都遇到过升级node版本，node扩展编译失败的情况。因为node扩展严重依赖于V8暴露的API，而node不同版本依赖的V8版本可能不同，一旦升级node版本，原先运行正常的node扩展就编译失败了。")]),a._v(" "),t("p",[a._v("这种情况对node生态圈无疑是不利的，N-API的引入正是试图改善这种情况的一种尝试。它跟底层JS引擎无关，只要N-API暴露的API足够稳定，那么node扩展的编写者就不用过分担忧node的升级问题。")]),a._v(" "),t("h2",{attrs:{id:"如何使用n-api"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#如何使用n-api"}},[a._v("#")]),a._v(" 如何使用N-API")]),a._v(" "),t("p",[a._v("先强调一点，N-API并不是对原有node扩展实现方式的替代，它只是提供了一系列底层无关的API，来帮助开发者编写跨版本的node扩展。至于如何编写、编译、使用扩展，跟原来的差不多。")]),a._v(" "),t("p",[a._v("本文会从一个超级简单的例子，简单介绍N-API的使用，包括环境准备、编写扩展、编译、运行几个步骤。")]),a._v(" "),t("blockquote",[t("p",[a._v("备注：当前N-API还处于试验阶段，官方文档提供的例子都是有问题的，如用于生产环境需格外谨慎。")])]),a._v(" "),t("h2",{attrs:{id:"_1、环境准备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、环境准备"}},[a._v("#")]),a._v(" 1、环境准备")]),a._v(" "),t("p",[a._v("首先，N-API是8.0版本引入的，首先确保本地安装了8.0版本。笔者用的是"),t("code",[a._v("nvm")]),a._v("，读者可自行选择安装方式。")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("nvm i "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("8.0")]),a._v("\nnvm use "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("8.0")]),a._v("\n")])])]),t("p",[a._v("然后，安装"),t("code",[a._v("node-gyp")]),a._v("，编译扩展会用到。")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("npm")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-g")]),a._v(" node-gyp\n")])])]),t("p",[a._v("创建项目目录，并初始化"),t("code",[a._v("package.json")]),a._v("。")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" hello "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("cd")]),a._v(" hello "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 目录名随便起")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("npm")]),a._v(" init "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-f")]),a._v("\n")])])]),t("h2",{attrs:{id:"_2、编写扩展"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、编写扩展"}},[a._v("#")]),a._v(" 2、编写扩展")]),a._v(" "),t("p",[a._v("创建"),t("code",[a._v("hello.cc")]),a._v("作为扩展的源文件。")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" src\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("touch")]),a._v(" src/hello.cc\n")])])]),t("p",[a._v("编辑"),t("code",[a._v("hello.cc")]),a._v("，输入如下内容。")]),a._v(" "),t("div",{staticClass:"language-c extra-class"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[a._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[a._v("include")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("<node_api.h>")])]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 实际暴露的方法，这里只是简单返回一个字符串")]),a._v("\nnapi_value "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("HelloMethod")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("napi_env env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" napi_callback_info info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    napi_value world"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("napi_create_string_utf8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"world"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),a._v("world"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v(" world"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 扩展的初始化方法，其中 ")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// env：环境变量")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// exports、module：node模块中对外暴露的对象")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("Init")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("napi_env env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" napi_value exports"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" napi_value module"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v(" priv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// napi_property_descriptor 为结构体，作用是描述扩展暴露的 属性/方法 的描述")]),a._v("\n    napi_property_descriptor desc "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"hello"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" HelloMethod"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" napi_default"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("napi_define_properties")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" exports"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),a._v("desc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 定义暴露的方法")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("NAPI_MODULE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("hello"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" Init"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 注册扩展，扩展名叫做hello，Init为扩展的初始化方法")]),a._v("\n")])])]),t("h2",{attrs:{id:"_3、编译扩展"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3、编译扩展"}},[a._v("#")]),a._v(" 3、编译扩展")]),a._v(" "),t("p",[a._v("首先，创建编译描述文件"),t("code",[a._v("binding.gyp")]),a._v("。")]),a._v(" "),t("div",{staticClass:"language-json extra-class"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[a._v('"targets"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[a._v('"target_name"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"hello"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[a._v('"sources"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"./src/hello.cc"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),t("p",[a._v("然后，运行如下命令进行编译。")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("node-gyp rebuild\n")])])]),t("h2",{attrs:{id:"_4、调用扩展"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4、调用扩展"}},[a._v("#")]),a._v(" 4、调用扩展")]),a._v(" "),t("p",[a._v("未方便调用扩展，先安装"),t("code",[a._v("bindings")]),a._v("。")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("npm")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--save")]),a._v(" bindings\n")])])]),t("p",[a._v("然后，创建"),t("code",[a._v("app.js")]),a._v("，调用刚编译的扩展。")]),a._v(" "),t("div",{staticClass:"language-javascript extra-class"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("var")]),a._v(" addon "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("require")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'bindings'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'hello'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\nconsole"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v(" addon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("hello")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// world")]),a._v("\n")])])]),t("p",[a._v("运行代码，由于N-API当前尚处于Experimental阶段，记得加上"),t("code",[a._v("--napi-modules")]),a._v("标记。")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("node")]),a._v(" --napi-modules app.js\n")])])]),t("p",[a._v("输出如下")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"path"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/data/github/abi-stable-node-addon-examples/1_hello_world/napi/build/Release/hello.node"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\nworld\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("node:6500"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" Warning: N-API is an experimental feature and could change at any time.\n")])])]),t("h2",{attrs:{id:"相关链接"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#相关链接"}},[a._v("#")]),a._v(" 相关链接")]),a._v(" "),t("p",[a._v("N-API：https://nodejs.org/api/n-api.html")]),a._v(" "),t("p",[a._v("C++ Addons：https://nodejs.org/api/addons.html")])])}),[],!1,null,null,null);t.default=e.exports}}]);